var dependencies=["ionic","w5c.validator","angular-jwt","monospaced.qrcode","btford.socket-io","ngCordova","yiyangbao.services","yiyangbao.directives","yiyangbao.filters","yiyangbao.controllers","yiyangbao.controllers.user","yiyangbao.controllers.backend"],myAppVersion="0.0.1";if(!navigator.connection)var Connection={NONE:!1};var app=angular.module("yiyangbao",dependencies);app.config(["$stateProvider","$urlRouterProvider","$urlMatcherFactoryProvider","$locationProvider","$provide","CONFIG",function($stateProvider,$urlRouterProvider,$urlMatcherFactoryProvider,$locationProvider,$provide,CONFIG){var ACL=function(){function buildRoles(roles){var bitMask="01",userRoles={};for(var role in roles){var intCode=parseInt(bitMask,2);userRoles[roles[role]]={bitMask:intCode,title:roles[role]},bitMask=(intCode<<1).toString(2)}return userRoles}function buildAccessLevels(accessLevelDeclarations,userRoles){var resultBitMask,accessLevels={};for(var level in accessLevelDeclarations)if("string"==typeof accessLevelDeclarations[level])if("*"==accessLevelDeclarations[level]){resultBitMask="";for(var r in userRoles)resultBitMask+="1";accessLevels[level]={bitMask:parseInt(resultBitMask,2)}}else console.log("Access Control Error: Could not parse '"+accessLevelDeclarations[level]+"' as access definition for level '"+level+"'");else{resultBitMask=0;for(var role in accessLevelDeclarations[level])userRoles.hasOwnProperty(accessLevelDeclarations[level][role])?resultBitMask|=userRoles[accessLevelDeclarations[level][role]].bitMask:console.log("Access Control Error: Could not find role '"+accessLevelDeclarations[level][role]+"' in registered roles while building access for '"+level+"'");accessLevels[level]={bitMask:resultBitMask}}return accessLevels}var userRoles=buildRoles(CONFIG.userRoles),accessLevels=buildAccessLevels(CONFIG.accessLevels,userRoles);return{userRoles:userRoles,accessLevels:accessLevels}},acl=ACL(),access=acl.accessLevels;$provide.service("ACL",function(){return acl}),$urlMatcherFactoryProvider.strictMode(!1),$stateProvider.state("intro",{url:"/intro",templateUrl:"partials/about/intro.html",controller:"intro",data:{access:access["public"]}}),$stateProvider.state("public",{"abstract":!0,templateUrl:"partials/sideMenuLeft.html",controller:"publicSideMenu",data:{access:access["public"]}}).state("public.aboutUs",{url:"/aboutUs",templateUrl:"partials/about/aboutUs.html",data:{menuToggle:!0},controller:"aboutUs"}).state("public.agreement",{url:"/agreement",templateUrl:"partials/about/agreement.html",data:{menuToggle:!0},controller:"agreement"}).state("public.settings",{url:"/settings",templateUrl:"partials/about/settings.html",data:{menuToggle:!0},controller:"settings"}).state("public.feedback",{url:"/feedback",templateUrl:"partials/about/feedback.html",controller:"feedback"}),$stateProvider.state("user",{"abstract":!0,url:"/user",templateUrl:"partials/user/tabsBottom.html",controller:"userTabsBottom",data:{access:access.user}}).state("user.home",{url:"/home",views:{userHome:{templateUrl:"partials/user/home.html",controller:"userHome"}}}).state("user.ConsList",{url:"/ConsList",views:{userConsList:{templateUrl:"partials/user/ConsList.html",controller:"userConsList"}}}).state("user.activities",{url:"/activities",views:{userActivities:{templateUrl:"partials/user/activities.html",controller:"userActivities"}}}).state("user.around",{url:"/around",views:{userAround:{templateUrl:"partials/user/around.html",controller:"userAround"}}}).state("user.settings",{url:"/settings",views:{userHome:{templateUrl:"partials/user/settings.html",controller:"userSettings"}}}).state("user.feedback",{url:"/feedback",views:{userHome:{templateUrl:"partials/user/feedback.html",controller:"userFeedback"}}}).state("user.mine",{url:"/mine",views:{userHome:{templateUrl:"partials/user/mine.html",controller:"userMine"}}}).state("user.helper",{url:"/helper",views:{userHome:{templateUrl:"partials/user/helper.html",controller:"userHelper"}}}).state("user.search",{url:"/search",views:{userConsList:{templateUrl:"partials/common/search.html",controller:"userSearch"}}}),$stateProvider.state("serv",{"abstract":!0,url:"/serv",templateUrl:"partials/backend/serv/tabsBottom.html",data:{access:access.serv}}).state("serv.home",{url:"/home",views:{servHome:{templateUrl:"partials/backend/serv/home.html",controller:"servHome"}}}),$stateProvider.state("medi",{"abstract":!0,url:"/medi",templateUrl:"partials/backend/medi/tabsBottom.html",controller:"mediTabsBottom",data:{access:access.medi}}).state("medi.barcode",{cache:!1,url:"/barcode",views:{mediBarcode:{templateUrl:"partials/backend/medi/barcode.html",controller:"mediBarcode"}}}).state("medi.ConsList",{url:"/ConsList",views:{mediConsList:{templateUrl:"partials/backend/medi/ConsList.html",controller:"mediConsList"}}}).state("medi.receipt",{url:"/receipt",views:{mediReceipt:{templateUrl:"partials/backend/medi/receipt.html",controller:"mediReceipt"}}}).state("medi.home",{url:"/home",views:{mediHome:{templateUrl:"partials/backend/medi/home.html",controller:"mediHome"}}}).state("medi.mine",{url:"/mine",views:{mediHome:{templateUrl:"partials/backend/medi/mine.html",controller:"mediMine"}}}).state("medi.helper",{url:"/helper",views:{mediHome:{templateUrl:"partials/backend/medi/helper.html",controller:"mediHelper"}}}).state("medi.settings",{url:"/settings",views:{mediHome:{templateUrl:"partials/backend/medi/settings.html",controller:"mediSettings"}}}).state("medi.feedback",{url:"/feedback",views:{mediHome:{templateUrl:"partials/backend/medi/feedback.html",controller:"mediFeedback"}}}).state("medi.search",{url:"/search",views:{mediConsList:{templateUrl:"partials/common/search.html",controller:"mediSearch"}}}).state("medi.ConsDetail",{url:"/ConsDetail/:consId",params:{cons:null},views:{mediConsList:{templateUrl:"partials/backend/medi/ConsDetail.html",controller:"mediConsDetail"}}})}]).config(["$ionicConfigProvider",function($ionicConfigProvider){$ionicConfigProvider.views.maxCache(10),$ionicConfigProvider.views.forwardCache(!0),$ionicConfigProvider.backButton.icon("ion-ios7-arrow-back"),$ionicConfigProvider.backButton.text(""),$ionicConfigProvider.backButton.previousTitleText(!1),$ionicConfigProvider.tabs.position("bottom"),$ionicConfigProvider.navBar.alignTitle("center")}]).config(["$httpProvider","jwtInterceptorProvider",function($httpProvider,jwtInterceptorProvider){jwtInterceptorProvider.tokenGetter=["config","jwtHelper","$http","CONFIG","Storage",function(config,jwtHelper,$http,CONFIG,Storage){var token=Storage.get("token"),refreshToken=Storage.get("refreshToken"),isExpired=!0;try{isExpired=jwtHelper.isTokenExpired(token)}catch(e){isExpired=!0}return".html"===config.url.substr(config.url.length-5)?null:isExpired?refreshToken&&refreshToken.length>=16?$http({url:CONFIG.baseUrl+"refreshToken",skipAuthorization:!0,method:"POST",timeout:5e3,data:{grant_type:"refresh_token",refresh_token:refreshToken}}).then(function(res){return Storage.set("token",res.data.token),Storage.set("refreshToken",res.data.refreshToken),res.data.token},function(err){return console.log(err),null}):(Storage.rm("refreshToken"),null):token}],$httpProvider.interceptors.push("jwtInterceptor")}]).config(["w5cValidatorProvider",function(w5cValidatorProvider){w5cValidatorProvider.config({blurTrig:!1,showError:!0,removeError:!0}),w5cValidatorProvider.setRules({email:{required:"邮箱地址不能为空",email:"输入邮箱的格式不正确"},username:{required:"输入的用户名不能为空",pattern:"用户名只能包含字母, 数字, 下划线"},password:{required:"密码不能为空",minlength:"密码长度不能小于{minlength}",maxlength:"密码长度不能大于{maxlength}"},repeatPassword:{required:"密码不能为空",repeat:"两次填写的密码不一致"},oldPassword:{required:"密码不能为空",minlength:"密码长度不能小于{minlength}",maxlength:"密码长度不能大于{maxlength}"},newPassword:{required:"密码不能为空",minlength:"密码长度不能小于{minlength}",maxlength:"密码长度不能大于{maxlength}"},repeatPwd:{required:"密码不能为空",repeat:"两次填写的密码不一致"},oldDealPassword:{required:"密码不能为空",minlength:"密码长度不能小于{minlength}",maxlength:"密码长度不能大于{maxlength}"},newDealPassword:{required:"密码不能为空",minlength:"密码长度不能小于{minlength}",maxlength:"密码长度不能大于{maxlength}"},name:{required:"姓名不能为空",pattern:"请正确输入中文姓名"},mobile:{required:"手机号不能为空",pattern:"请填写正确手机号",minlength:"手机号长度不能小于{minlength}",maxlength:"手机号长度不能大于{maxlength}"},tel:{pattern:"请填写正确电话号",minlength:"电话号长度不能小于{minlength}",maxlength:"电话号长度不能大于{maxlength}"},idNo:{required:"证件号不能为空",pattern:"请填写正确证件号",minlength:"证件号长度不能小于{minlength}",maxlength:"证件号长度不能大于{maxlength}"},money:{required:"金额不能为空",min:"最小金额0.01元"}})}]).run(["$ionicPlatform","$rootScope","$state","Storage","Token","$ionicPopup",function($ionicPlatform,$rootScope,$state,Storage,Token,$ionicPopup){$ionicPlatform.ready(function(){switch(window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),$rootScope.myOnline=navigator.connection?navigator.connection.type:window.navigator.onLine,$ionicPlatform.on("online",function(){$rootScope.myOnline=navigator.connection?navigator.connection.type:window.navigator.onLine,$rootScope.$broadcast("onOnline")},!1),$ionicPlatform.on("offline",function(){$rootScope.myOnline=navigator.connection?navigator.connection.type:window.navigator.onLine,$rootScope.$broadcast("onOffline")},!1),Token.curUserRole()){case"public":$state.go("public.aboutUs");break;case"serv":$state.go("serv.home");break;case"medi":$state.go("medi.home");break;default:$state.go("user.home")}})}]).run(["$rootScope","$state","$ionicHistory","Auth","ACL","Token","User","Storage","PageFunc",function($rootScope,$state,$ionicHistory,Auth,ACL,Token,User,Storage,PageFunc){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){"data"in toState&&"access"in toState.data?!Auth.authorize(toState.data.access)||Auth.isLoggedIn()||Storage.get("refreshToken")||toState.data.access.bitMask===ACL.accessLevels["public"].bitMask||toState.data.access.bitMask===ACL.accessLevels.anon.bitMask?Auth.authorize(toState.data.access)||(event.preventDefault(),Auth.isLoggedIn()||Storage.get("refreshToken")?(PageFunc.message("页面不存在或不能浏览!",2e3),$state.go(fromState.name||"user.home")):($rootScope.state={toStateName:toState.name,fromStateName:fromState.name},User.loginModal($rootScope))):(event.preventDefault(),$rootScope.state={toStateName:toState.name,fromStateName:fromState.name},User.loginModal($rootScope)):(event.preventDefault(),PageFunc.message("当前内容建设中, 敬请期待!",2e3),$state.go(fromState.name||"anon.login")),toState.data.menuToggle&&$ionicHistory.nextViewOptions({disableBack:!0})})}]),angular.module("yiyangbao.controllers.backend",[]).controller("mediTabsBottom",["$scope","$timeout","$state","$cordovaBarcodeScanner",function($scope,$timeout,$state,$cordovaBarcodeScanner){$scope.newConsNum=1,$scope.actions={clearConsBadge:function(){$timeout(function(){$scope.newConsNum=0},500)}}}]).controller("mediBarcode",["$scope","$state","$cordovaBarcodeScanner","PageFunc","Insurance","Consumption","User","Socket","Storage",function($scope,$state,$cordovaBarcodeScanner,PageFunc,Insurance,Consumption,User,Socket,Storage){$scope.error={};var payingPopup,inceInfo;$scope.actions={scan:function(event){$scope.error.checkError="",$cordovaBarcodeScanner.scan().then(function(result){if(result.cancelled)return console.log("用户取消");var barcode=result.text;$scope.payBill={mediId:JSON.parse(Storage.get("info"))._id,userSocketId:barcode.split(")|(")[0],available:barcode.split(")|(")[1]},inceInfo=null,void 0===$scope.payBill.available&&(barcode=$scope.payBill.userSocketId,Insurance.getInfo({seriesNum:barcode}).then(function(data){inceInfo=data.results,$scope.payBill.available=data.results.ince.available,$scope.dealPwd=data.results.user.dealPwd},function(err){$scope.error.checkError=err.data}))},function(err){console.log(err)})},check:function(){inceInfo?$scope.dealPwd===!0?PageFunc.prompt("支付密码","请输入支付密码").then(function(res){if(res){var ince=inceInfo.ince,cons={userId:inceInfo.user._id,money:$scope.payBill.money,note:$scope.payBill.note,mediId:$scope.payBill.mediId,incePolicyId:ince._id,unitId:ince.unitId,inceId:ince.inceId,servId:ince.servId,password:res};Consumption.insertOne(cons).then(function(data){$scope.error.checkError="用户支付"+data.results.cons.money+"元",$scope.payBill.money=null,$scope.payBill.available=void 0},function(err){$scope.error.checkError=err.data})}else $scope.error.checkError="未输入密码!"}):User.dealPasswordModal($scope,null,!0):(Socket.emit("pay bill",$scope.payBill,"check"),payingPopup=PageFunc.message("用户支付中..."))}},Socket.on("pay bill",function(data,actions,options,cb){("paid"===actions||"payError"===actions||"cancelPay"===actions)&&(payingPopup.close(data),$scope.error.checkError=data.msg||"用户取消支付","paid"===actions&&($scope.payBill.money=null,$scope.payBill.available=void 0))}),$scope.$on("modal.hidden",function(){$scope.error.checkError="取消输入"})}]).controller("mediConsList",["$scope","$q","$ionicPopover","Consumption",function($scope,$q,$ionicPopover,Consumption){var batch=null,lastTime=null,init=function(){var deferred=$q.defer();return Consumption.getList(null,{skip:0,limit:batch}).then(function(data){$scope.items=data.results,lastTime=Date.now(),deferred.resolve()},function(err){console.log(err.data),deferred.reject()}),deferred.promise};init(),$scope.$on("$ionicView.beforeEnter",function(){var thisMoment=Date.now();(thisMoment-lastTime)/36e5>1&&init()}),$scope.filters={title:"消费记录筛选",isCheckBox:!0,checkBoxItems:[{text:"已提交",checked:!1},{text:"已审核",checked:!1},{text:"已核销",checked:!1}],height:"240px"},$ionicPopover.fromTemplateUrl("partials/popover/filter.html",{scope:$scope}).then(function(popover){$scope.filterPopover=popover}),$scope.$on("$destroy",function(){$scope.filterPopover.remove()}),$scope.actions={doRefresh:function(){init()["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},showFilter:function($event){$scope.filterPopover.show($event)},closeFilter:function(){$scope.filterPopover.hide()}}}]).controller("mediConsDetail",["$q","$scope","$state","$stateParams","$cordovaCamera","$cordovaFileTransfer","$timeout","PageFunc","Consumption","CONFIG","Storage",function($q,$scope,$state,$stateParams,$cordovaCamera,$cordovaFileTransfer,$timeout,PageFunc,Consumption,CONFIG,Storage){$scope.error={};var cameraOptions=CONFIG.cameraOptions,uploadOptions=CONFIG.uploadOptions;$scope.pageHandler={progress:0,showDelete:!1},$scope.actions={showDelete:function(){$scope.pageHandler.showDelete=!$scope.pageHandler.showDelete},deleteImg:function(item,$index){PageFunc.confirm("是否确认删除?","删除图片").then(function(res){res&&(Consumption.updateOne({_id:$stateParams.consId,pull:item.receiptImg[$index]}).then(function(data){},function(err){$scope.error.receiptError=err.data,console.log(err.data)}),item.receiptImg.splice($index,1))})},takePic:function(){$cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.consReceiptUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName=$stateParams.consId+CONFIG.uploadOptions.fileExt,uploadOptions.params={_id:$stateParams.consId},PageFunc.confirm("是否上传?","上传图片").then(function(res){if(res)return $cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$scope.error.receiptError="上传成功!",$scope.item.receiptImg=JSON.parse(result.response).results.receiptImg;try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){console.log(err),$scope.error.receiptError=err,$scope.pageHandler.progress=0;try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100});$scope.pageHandler.progress=0,$scope.error.receiptError="取消上传!";try{$cordovaCamera.cleanup().then(function(){},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.receiptError=err,console.log(err)})},submit:function(){PageFunc.confirm("是否提交?","提交记录").then(function(res){return res?Consumption.updateOne({_id:$stateParams.consId,set:"submit"}).then(function(data){$scope.item=data.results,$scope.error.receiptError="提交成功!"},function(err){$scope.error.receiptError=err.data,console.log(err.data)}):void 0})},doRefresh:function(){init(!0)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})}};var init=function(refresh){var deferred=$q.defer();return $stateParams.cons&&!refresh?($scope.item=$stateParams.cons,deferred.resolve()):Consumption.getOne({_id:$stateParams.consId}).then(function(data){$scope.item=data.results,deferred.resolve()},function(err){deferred.reject(),console.log(err.data)}),deferred.promise};init()}]).controller("mediReceipt",["$scope",function($scope){}]).controller("mediHome",["$scope","Storage","$q","User",function($scope,Storage,$q,User){User.initInfo($scope),$scope.actions={doRefresh:function(){User.initInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})}}}]).controller("mediMine",["$scope","$ionicPopup","$q","$ionicActionSheet","$cordovaCamera","$cordovaFileTransfer","Storage","User","$timeout","PageFunc","CONFIG",function($scope,$ionicPopup,$q,$ionicActionSheet,$cordovaCamera,$cordovaFileTransfer,Storage,User,$timeout,PageFunc,CONFIG){$scope.config={q1:CONFIG.q1,q2:CONFIG.q2,q3:CONFIG.q3,images:[{title:"营业执照"},{title:"机构照片"}]},$scope.pageHandler={progress:0},$scope.data={};var cameraOptions=angular.copy(CONFIG.cameraOptions),uploadOptions=angular.copy(CONFIG.uploadOptions);User.initInfo($scope),$scope.actions={doRefresh:function(){User.initInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},chgHead:function(){$ionicActionSheet.show({buttons:[{text:"<b>拍摄头像</b>"},{text:"相册照片"}],titleText:"设置头像",cancelText:"取消",cancel:function(){},buttonClicked:function(index){switch(cameraOptions.quality=10,cameraOptions.allowEdit=!0,cameraOptions.targetWidth=200,cameraOptions.targetHeight=200,cameraOptions.cameraDirection=1,index){case 0:cameraOptions.sourceType=1;break;case 1:cameraOptions.sourceType=2}return $cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.userResUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName="userHead"+CONFIG.uploadOptions.fileExt,uploadOptions.params={method:"$set",dest:"head",replace:!0},PageFunc.confirm("是否上传?","上传头像").then(function(res){if(res)return $cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$scope.info.head={Url:JSON.parse(result.response).results.Url};try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){console.log(err),$scope.error.receiptError=err,$scope.pageHandler.progress=0;try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100});$scope.pageHandler.progress=0,$scope.error.receiptError="取消上传!";try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.receiptError=err,console.log(err)}),!0}})},chgUsername:function(){$scope.info.username===$scope.info.personalInfo.idNo&&($scope.config.title="修改用户名",$scope.data.key="username",$scope.data.value=$scope.info.username,$scope.actions.show())},chgMobile:function(){$scope.config.title="修改手机号",$scope.data.key="mobile",$scope.data.value=$scope.info.mobile,$scope.actions.show()},chgEmail:function(){$scope.config.title="修改邮箱地址",$scope.data.key="email",$scope.data.value=$scope.info.email,$scope.actions.show()},chgPwd:function(){$scope.passwordModal?$scope.passwordModal.show():User.passwordModal($scope)},chgPwdQst:function(){PageFunc.prompt("登录密码","请输入登录密码").then(function(res){res&&User.verifyPwd(res).then(function(data){"OK"===data.results&&($scope.config.title="设置密保问题",$scope.pwdQstModal?$scope.pwdQstModal.show():User.pwdQstModal($scope))},function(err){console.log(err.data)})})},chgName:function(){$scope.config.title="修改机构名",$scope.data.key="personalInfo.name",$scope.data.value=$scope.info.personalInfo.name,$scope.actions.show()},chgIdNo:function(){PageFunc.message("如有错误, 请联系服务专员修改!<br>"+CONFIG.serv400)},chgLocation:function(){$scope.config.title="修改地址",$scope.data.key="personalInfo.location.city.name",$scope.data.value=$scope.info.personalInfo.location&&$scope.info.personalInfo.location.city&&$scope.info.personalInfo.location.city.name,$scope.actions.show()},chgIdImg:function(){$scope.config.title="拍摄机构照片",$scope.takePicsModal?$scope.takePicsModal.show():User.takePicsModal($scope,$scope.info.personalInfo.idImg)},chgIntro:function(){$scope.config.title="修改机构介绍",$scope.data.key="personalInfo.intro",$scope.data.value=$scope.info.personalInfo.intro,$scope.actions.show(!0)}},$scope.$on("$ionicView.loaded",function(){User.updateModal($scope)})}]).controller("mediHelper",["$scope",function($scope){}]).controller("mediSettings",["$scope","$ionicPopup","$q","Storage","User",function($scope,$ionicPopup,$q,Storage,User){User.initInfo($scope),$scope.actions={doRefresh:function(){User.initInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},clearCache:function(){var token=Storage.get("token")||"",refreshToken=Storage.get("refreshToken")||"",myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),token&&Storage.set("token",token),refreshToken&&Storage.set("refreshToken",refreshToken),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$ionicPopup.alert({title:"缓存",template:"<h4><b>清理成功</b></h4>"})},logout:function(){User.logout($scope)}}}]).controller("mediFeedback",["$scope",function($scope){}]).controller("mediSearch",["$scope",function($scope){}]),angular.module("yiyangbao.controllers",[]).controller("main",["$scope",function($scope){}]).controller("intro",["$scope","Storage",function($scope,Storage){Storage.set("myAppVersion",myAppVersion)}]).controller("publicSideMenu",["$scope","$ionicPopup","Storage","User",function($scope,$ionicPopup,Storage,User){$scope.state={},$scope.sideMenu={firstItem:{click:function(){User.loginModal($scope)},title:"请登录",imgSrc:""},items:[{href:"#/aboutUs",iconClass:"ion-ios-information-outline",title:"关于我们"},{href:"#/agreement",iconClass:"ion-ios-compose-outline",title:"用户协议"},{href:"#/settings",iconClass:"ion-ios-gear-outline",title:"系统设置"}]}}]).controller("aboutUs",["$scope",function($scope){}]).controller("agreement",["$scope",function($scope){}]).controller("settings",["$scope","$ionicPopup","Storage","User",function($scope,$ionicPopup,Storage,User){$scope.userName="王林",$scope.signature="",$scope.actions={clearCache:function(){var token=Storage.get("token")||"",refreshToken=Storage.get("refreshToken")||"",myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),token&&Storage.set("token",token),refreshToken&&Storage.set("refreshToken",refreshToken),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$ionicPopup.alert({title:"缓存",template:"<h4><b>清理成功</b></h4>"})},logout:function(){User.logout($scope)}}}]).controller("feedback",["$scope","$ionicHistory",function($scope,$ionicHistory){}]).controller("header",["$scope",function($scope){}]).controller("footer",["$scope",function($scope){}]),angular.module("yiyangbao.controllers.user",[]).controller("userTabsBottom",["$scope","$timeout",function($scope,$timeout){$scope.newConsNum=1,$scope.actions={clearConsBadge:function(){$timeout(function(){$scope.newConsNum=0},500)}}}]).controller("userHome",["$scope","$q","$timeout","PageFunc","Storage","User","Consumption","Socket",function($scope,$q,$timeout,PageFunc,Storage,User,Consumption,Socket){var init=function(){var deferred=$q.defer(),deferredInfo=$q.defer(),deferredBarcode=$q.defer();return User.initAccInfo($scope).then(function(data){deferredInfo.resolve(data)},function(err){deferredInfo.reject(err)}),Socket.emit("pay bill",null,null,null,function(socketId){deferredBarcode.resolve(socketId)}),$timeout(function(){deferredBarcode.reject("连接超时!")},1e4),$q.all([deferredInfo.promise,deferredBarcode.promise]).then(function(data){$scope.accountInfo.barcode=data[1]+")|("+(data[0].ince.available||0),deferred.resolve()},function(errors){console.log(errors),deferred.reject()}),deferred.promise};init(),Socket.on("pay bill",function(data,actions,options,cb){var AccInfo=JSON.parse(Storage.get("AccInfo")),userId=AccInfo.user._id,ince=AccInfo.ince,socketData=data;"check"===actions&&PageFunc.prompt("支付密码","请输入支付密码").then(function(res){if(res){var cons={userId:userId,money:socketData.money,note:socketData.note,mediId:socketData.mediId,incePolicyId:ince._id,unitId:ince.unitId,inceId:ince.inceId,servId:ince.servId,password:res};Consumption.insertOne(cons).then(function(data){$scope.error.payError="您消费"+data.results.cons.money+"元!",Socket.emit("pay bill",{mediSocketId:socketData.mediSocketId,msg:"用户支付"+data.results.cons.money+"元!"},"paid"),$scope.accountInfo.ince.available=data.results.ince.available,$scope.accountInfo.barcode=$scope.accountInfo.barcode.split(")|(")[0]+")|("+data.results.ince.available},function(err){$scope.error.payError=err.data,Socket.emit("pay bill",{mediSocketId:socketData.mediSocketId,msg:err.data},"payError")})}else Socket.emit("pay bill",{mediSocketId:socketData.mediSocketId},"cancelPay")})}),$scope.actions={doRefresh:function(){init()["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})}}}]).controller("userConsList",["$scope","$q","Consumption",function($scope,$q,Consumption){var batch=null,lastTime=null,init=function(){var deferred=$q.defer();return Consumption.getList(null,{skip:0,limit:batch}).then(function(data){$scope.items=data.results,lastTime=Date.now(),deferred.resolve()},function(err){console.log(err.data),deferred.reject()}),deferred.promise};init(),$scope.$on("$ionicView.beforeEnter",function(){var thisMoment=Date.now();(thisMoment-lastTime)/36e5>1&&init()}),$scope.actions={doRefresh:function(){init()["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})}}}]).controller("userActivities",["$scope",function($scope){}]).controller("userAround",["$scope",function($scope){}]).controller("userMine",["$scope","$ionicPopup","$q","$ionicActionSheet","$cordovaCamera","$cordovaFileTransfer","Storage","User","$timeout","PageFunc","CONFIG",function($scope,$ionicPopup,$q,$ionicActionSheet,$cordovaCamera,$cordovaFileTransfer,Storage,User,$timeout,PageFunc,CONFIG){$scope.config={genders:CONFIG.genders,q1:CONFIG.q1,q2:CONFIG.q2,q3:CONFIG.q3,images:[{title:"身份证正面"},{title:"身份证反面"},{title:"病历首页"}]},$scope.pageHandler={progress:0},$scope.data={};var cameraOptions=angular.copy(CONFIG.cameraOptions),uploadOptions=angular.copy(CONFIG.uploadOptions);User.initAccInfo($scope),$scope.actions={doRefresh:function(){User.initAccInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},chgHead:function(){$ionicActionSheet.show({buttons:[{text:"<b>拍摄头像</b>"},{text:"相册照片"}],titleText:"设置头像",cancelText:"取消",cancel:function(){},buttonClicked:function(index){switch(cameraOptions.quality=10,cameraOptions.allowEdit=!0,cameraOptions.targetWidth=200,cameraOptions.targetHeight=200,cameraOptions.cameraDirection=1,index){case 0:cameraOptions.sourceType=1;break;case 1:cameraOptions.sourceType=2}return $cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.userResUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName="userHead"+CONFIG.uploadOptions.fileExt,uploadOptions.params={method:"$set",dest:"head",replace:!0},PageFunc.confirm("是否上传?","上传头像").then(function(res){if(res)return $cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$scope.accountInfo.user.head={Url:JSON.parse(result.response).results.Url};try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){console.log(err),$scope.error.receiptError=err,$scope.pageHandler.progress=0;try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100});$scope.pageHandler.progress=0,$scope.error.receiptError="取消上传!";try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.receiptError=err,console.log(err)}),!0}})},chgUsername:function(){$scope.accountInfo.user.username===$scope.accountInfo.user.personalInfo.idNo&&($scope.config.title="修改用户名",$scope.data.key="username",$scope.data.value=$scope.accountInfo.user.username,$scope.actions.show())},chgMobile:function(){$scope.config.title="修改手机号",$scope.data.key="mobile",$scope.data.value=$scope.accountInfo.user.mobile,$scope.actions.show()},chgEmail:function(){$scope.config.title="修改邮箱地址",$scope.data.key="email",$scope.data.value=$scope.accountInfo.user.email,$scope.actions.show()},chgPwd:function(){$scope.passwordModal?$scope.passwordModal.show():User.passwordModal($scope)},chgPwdQst:function(){PageFunc.prompt("登录密码","请输入登录密码").then(function(res){res&&User.verifyPwd(res).then(function(data){"OK"===data.results&&($scope.config.title="设置密保问题",$scope.pwdQstModal?$scope.pwdQstModal.show():User.pwdQstModal($scope))},function(err){console.log(err.data)})})},chgDealPwd:function(){$scope.dealPasswordModal?$scope.dealPasswordModal.show():User.dealPasswordModal($scope,$scope.accountInfo.user.extInfo.yiyangbaoHealInce.dealPassword,!0)},chgName:function(){$scope.config.title="修改姓名",$scope.data.key="personalInfo.name",$scope.data.value=$scope.accountInfo.user.personalInfo.name,$scope.actions.show()},chgGender:function(gender){User.updateOne({"personalInfo.gender":gender}).then(function(data){},function(err){console.log(err.data)})},chgBirthdate:function(birthdate){return birthdate?void User.updateOne({"personalInfo.birthdate":birthdate}).then(function(data){},function(err){console.log(err.data)}):($scope.accountInfo.user.personalInfo.birthdate=new Date(JSON.parse(Storage.get("AccInfo")).user.personalInfo.birthdate),PageFunc.message("生日不能为空!"))},chgIdNo:function(){PageFunc.message("如有错误, 请联系服务专员修改!<br>"+CONFIG.serv400)},chgLocation:function(){$scope.config.title="修改地址",$scope.data.key="personalInfo.location.city.name",$scope.data.value=$scope.accountInfo.user.personalInfo.location&&$scope.accountInfo.user.personalInfo.location.city&&$scope.accountInfo.user.personalInfo.location.city.name,$scope.actions.show()},chgIdImg:function(){$scope.config.title="拍摄证件照片",$scope.takePicsModal?$scope.takePicsModal.show():User.takePicsModal($scope,$scope.accountInfo.user.personalInfo.idImg)}},$scope.$on("$ionicView.loaded",function(){User.updateModal($scope)})}]).controller("userHelper",["$scope",function($scope){}]).controller("userSettings",["$scope","$ionicPopup","$q","Storage","User",function($scope,$ionicPopup,$q,Storage,User){User.initAccInfo($scope),$scope.actions={doRefresh:function(){User.initAccInfo($scope)["catch"](function(err){console.log(err)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},clearCache:function(){var token=Storage.get("token")||"",refreshToken=Storage.get("refreshToken")||"",myAppVersionLocal=Storage.get("myAppVersion")||"";

Storage.clear(),token&&Storage.set("token",token),refreshToken&&Storage.set("refreshToken",refreshToken),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$ionicPopup.alert({title:"缓存",template:"<h4><b>清理成功</b></h4>"})},logout:function(){User.logout($scope)}}}]).controller("userFeedback",["$scope",function($scope){}]).controller("userSearch",["$scope",function($scope){}]),angular.module("yiyangbao.directives",[]).directive("buttonClearInput",function(){return{restrict:"AE",scope:{input:"="},template:"<button ng-if='input' class='button button-icon ion-android-close input-button' type='button' ng-click='clearInput()'></button>",controller:function($scope,$element,$attrs){$scope.clearInput=function(){$scope.input=""}}}}),angular.module("yiyangbao.filters",[]).filter("mapGender",function(){var genderHash={1:"男",2:"女",3:"未知",4:"未申明",5:"其他","男":"男","女":"女",male:"男",female:"女"};return function(input){return input?genderHash[input]||"未知":"未知"}}).filter("mapTitle",function(){var genderHash={1:"先生",2:"女士"};return function(input){return input?genderHash[input]||"用户":"用户"}}),angular.module("yiyangbao.services",["ngResource"]).constant("CONFIG",{baseUrl:"http://192.168.1.108/",ioDefaultNamespace:"192.168.1.108/default",consReceiptUploadPath:"cons/receiptUpload",userResUploadPath:"user/resUpload",cameraOptions:{quality:15,destinationType:1,sourceType:1,encodingType:0,correctOrientation:!0,saveToPhotoAlbum:!1,cameraDirection:0},uploadOptions:{fileExt:".jpg",httpMethod:"POST",mimeType:"image/jpg"},showTime:500,userRoles:["public","user","serv","unit","medi","ince","admin","super"],accessLevels:{"public":"*",anon:["public"],user:["user","serv","unit","medi","ince","admin","super"],serv:["serv","super"],unit:["unit","super"],medi:["medi","super"],ince:["ince","super"],admin:["admin","super"]},genders:[1,2],q1:["父亲名字","母亲名字","配偶名字","小孩名字","父亲生日","母亲生日","配偶生日","小孩生日"],q2:["最喜欢的颜色","小学名称","初中名称","高中名称","大学的专业","最喜欢的演员"],q3:["最喜欢的歌曲","第一只宠物的名字","最喜欢的水果","最喜欢的食物","最喜欢的宠物"],serv400:"4008006666"}).factory("Storage",["$window",function($window){return{set:function(key,value){$window.localStorage.setItem(key,value)},get:function(key){return $window.localStorage.getItem(key)},rm:function(key){$window.localStorage.removeItem(key)},clear:function(){$window.localStorage.clear()}}}]).factory("Token",["Storage","jwtHelper","ACL",function(Storage,jwtHelper,ACL){return{curUserRole:function(){var userRole=ACL.userRoles["public"].title;try{userRole=jwtHelper.decodeToken(Storage.get("token")).userRole}catch(e){return ACL.userRoles["public"].title}return userRole},isExpired:function(){var isExpired=!0;try{isExpired=jwtHelper.isTokenExpired(Storage.get("token"))}catch(e){return!0}return isExpired}}}]).factory("Data",["$resource","$q","CONFIG","$interval",function($resource,$q,CONFIG,$interval){var self=this,abort=$q.defer(),User=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"user"},{verifyPwd:{method:"POST",params:{route:"verifyPwd"},timeout:1e4},login:{method:"POST",params:{route:"login"},timeout:1e4},getList:{method:"POST",params:{route:"getList"},timeout:abort.promise},getInfo:{method:"GET",params:{route:"getInfo"},timeout:1e4},getAccInfo:{method:"GET",params:{route:"getAccInfo"},timeout:1e4},updateOne:{method:"POST",params:{route:"updateOne"},timeout:1e4},updateOnesPwd:{method:"POST",params:{route:"updateOnesPwd"},timeout:1e4},logout:{method:"GET",params:{route:"logout"},timeout:1e4}})},Insurance=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"ince"},{getInfo:{method:"POST",params:{route:"getInfo"},timeout:1e4},getList:{method:"POST",params:{route:"getList"},timeout:abort.promise},modify:{method:"POST",params:{route:"modify"},timeout:1e4},remove:{method:"POST",params:{route:"remove"},timeout:1e4},removeOne:{method:"GET",params:{route:"removeOne"},timeout:1e4}})},Consumption=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"cons"},{insertOne:{method:"POST",params:{route:"insertOne"},timeout:1e4},getOne:{method:"POST",params:{route:"getOne"},timeout:1e4},getList:{method:"POST",params:{route:"getList"},timeout:abort.promise},updateOne:{method:"POST",params:{route:"updateOne"},timeout:1e4}})},Post=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"post"},{post:{method:"POST",params:{route:"post"},timeout:1e4},getList:{method:"POST",params:{route:"getList"},timeout:abort.promise},modify:{method:"POST",params:{route:"modify"},timeout:1e4},updateOne:{method:"POST",params:{route:"updateOne"},timeout:1e4},removeOne:{method:"GET",params:{route:"removeOne"},timeout:1e4}})},Resource=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"multer"},{rmBrokenFile:{method:"GET",params:{route:"upload"},timeout:1e4}})},Interface=function(){return $resource(CONFIG.baseUrl+":path/:route",{path:"interface"},{captchaImg:{method:"GET",params:{route:"captchaImg"},timeout:1e4}})};return self.abort=function($scope){abort.resolve(),$interval(function(){abort=$q.defer(),self.User=User(),self.Insurance=Insurance(),self.Consumption=Consumption(),self.Post=Post(),self.Resource=Resource(),self.Interface=Interface()},0,1)},self.User=User(),self.Insurance=Insurance(),self.Consumption=Consumption(),self.Post=Post(),self.Resource=Resource(),self.Interface=Interface(),self}]).factory("Socket",["socketFactory","CONFIG",function(socketFactory,CONFIG){return socketFactory({ioSocket:io.connect(CONFIG.baseUrl+CONFIG.ioDefaultNamespace)})}]).factory("User",["PageFunc","$cordovaCamera","$cordovaFileTransfer","CONFIG","$timeout","Storage","Data","Token","$state","$ionicHistory","$ionicModal","$q","$ionicSlideBoxDelegate","jwtHelper",function(PageFunc,$cordovaCamera,$cordovaFileTransfer,CONFIG,$timeout,Storage,Data,Token,$state,$ionicHistory,$ionicModal,$q,$ionicSlideBoxDelegate,jwtHelper){var self=this;return self.verifyPwd=function(pwd){var deferred=$q.defer();return Data.User.verifyPwd({password:pwd},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.login=function($scope){Data.User.login($scope.login,function(data,headers){$scope.error.loginError="";var userRole=jwtHelper.decodeToken(data.results.token).userRole;Storage.set("token",data.results.token),$scope.login.rememberme?Storage.set("refreshToken",data.results.refreshToken):Storage.rm("refreshToken"),data.results.justActivated&&("user"===userRole?self.dealPasswordModal($scope):self.passwordModal($scope)),$scope.loginModal&&$scope.loginModal.remove().then(function(){$scope.loginModal=null});var toStateName="medi"===userRole&&"medi.home"||"user.home";$state.go($scope.state.toStateName||toStateName)},function(err){var myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$scope.error.loginError=err.data||"连接超时!"})},self.getInfo=function(token,options,fields){var deferred=$q.defer();return Data.User.getInfo({token:token},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.getAccInfo=function(token,options,fields){var deferred=$q.defer();return Data.User.getAccInfo({token:token},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.updateOne=function(user,options){var deferred=$q.defer();return Data.User.updateOne({user:user,options:options},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.updateOnesPwd=function(user,options){var deferred=$q.defer();return Data.User.updateOnesPwd(user,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},self.logout=function($scope){var refreshToken=Storage.get("refreshToken")&&{refreshToken:Storage.get("refreshToken")}||{};Data.User.logout(refreshToken,function(data,headers){},function(err){});var myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$ionicHistory.clearHistory(),$ionicHistory.clearCache(),$state.go("public.aboutUs")},self.loginModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/login.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.loginModal=modal,$scope.loginModal.show()}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},self.registerModal($scope),$scope.actions.closeLogin=function(){$scope.loginModal.hide()},$scope.actions.showLogin=function(){$scope.loginModal.show()},$scope.actions.preRegister=function(){$scope.actions.closeLogin(),$scope.actions.showRegister()},$scope.actions.login=function(){self.login($scope)},$scope.login={username:"m",password:"a",rememberme:!0}},self.registerModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/register.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.registerModal=modal}),$scope.actions.closeRegister=function(){$scope.registerModal.hide()},$scope.actions.showRegister=function(){$scope.registerModal.show()},$scope.actions.preLogin=function(){$scope.actions.closeRegister(),$scope.actions.showLogin()},$scope.actions.register=function(){self.register($scope.register).then(function(data){$scope.error.registerError="",Storage.set("token",data.results.token),$scope.loginModal&&$scope.loginModal.remove().then(function(){$scope.loginModal=null}),$scope.registerModal.remove().then(function(){$scope.registerModal=null}),$state.go($scope.state.toStateName||"user.home")},function(err){var myAppVersionLocal=Storage.get("myAppVersion")||"";Storage.clear(),myAppVersionLocal&&Storage.set("myAppVersion",myAppVersionLocal),$scope.error.registerError=err.data})},$scope.register={username:"z",mobile:"13282037883",password:"a",repeatPassword:"a",name:"周天才",gender:!0,rememberme:!1}},self.passwordModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/password.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.passwordModal=modal,$scope.passwordModal.show()}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.password={targetKey:"password"},$scope.actions.closePassword=function(){$scope.passwordModal.hide()},$scope.actions.password=function(){self.updateOnesPwd($scope.password).then(function(){$scope.error.passwordError="",$scope.passwordModal.remove().then(function(){$scope.passwordModal=null})},function(err){$scope.error.passwordError=err.data})}},self.dealPasswordModal=function($scope,oldDealPwd,closeAble){$scope.closeAble=closeAble,$scope.oldDealPwd=oldDealPwd,$ionicModal.fromTemplateUrl("partials/modal/dealPassword.html",{scope:$scope,backdropClickToClose:!1,hardwareBackButtonClose:!1,animation:"slide-in-up"}).then(function(modal){$scope.dealPasswordModal=modal,$scope.dealPasswordModal.show()}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.payBill=$scope.payBill||{},$scope.dealPassword={seriesNum:$scope.payBill.userSocketId,targetKey:"extInfo.yiyangbaoHealInce.dealPassword"},$scope.password={targetKey:"password"},$scope.actions.closeDealPassword=function(){$scope.dealPasswordModal.hide()},$scope.actions.dealPassword=function(){console.log("正在修改支付密码",$scope.dealPassword),self.updateOnesPwd($scope.dealPassword).then(function(data){$scope.error.dealPasswordError="",$scope.dealPassword={targetKey:"extInfo.yiyangbaoHealInce.dealPassword"},$scope.dealPwd=!0,$scope.actions.check&&$scope.actions.check(),($scope.dealPassword.loginPwd||$scope.password.oldPassword)&&$scope.password.newPassword&&$scope.password.repeatPwd?($scope.password.loginPwd=$scope.dealPassword.loginPwd,$scope.password.seriesNum=$scope.dealPassword.seriesNum,console.log("正在修改密码",$scope.password),self.updateOnesPwd($scope.password).then(function(data){console.log(data.results),$scope.error.passwordError="",$scope.dealPasswordModal.remove().then(function(){$scope.dealPasswordModal=null})},function(){console.log(err),$scope.error.passwordError=err.data})):$scope.dealPasswordModal.remove().then(function(){$scope.dealPasswordModal=null})},function(err){console.log(err),$scope.error.dealPasswordError=err.data})}},self.updateModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/update.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.updateModal=modal}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.actions.cancel=function(){$scope.updateModal.hide()},$scope.actions.show=function(textarea){$scope.error.updateError="",$scope.textarea=textarea,$scope.updateModal.show()},$scope.actions.submit=function(){if(!$scope.data.value)return void($scope.error.updateError="输入不能为空!");var upData={};upData[$scope.data.key]=$scope.data.value,self.updateOne(upData).then(function(data){$scope.error.updateError="",$scope.data={},$scope.accountInfo&&($scope.accountInfo.user=data.results,$scope.accountInfo.user.personalInfo.birthdate=new Date($scope.accountInfo.user.personalInfo.birthdate)),$scope.info&&($scope.info=data.results,$scope.info.personalInfo.birthdate=new Date($scope.info.personalInfo.birthdate)),$scope.actions.cancel()},function(err){return err.data.name?void($scope.error.updateError="数据库写入错误!"):void($scope.error.updateError=err.data)})}},self.pwdQstModal=function($scope){$ionicModal.fromTemplateUrl("partials/modal/pwdQst.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.pwdQstModal=modal,$scope.pwdQstModal.show()}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.pwdQst=[],$scope.actions.closePwdQst=function(){$scope.pwdQstModal.hide()},$scope.actions.pwdQst=function(){return $scope.pwdQst[0]&&$scope.pwdQst[1]&&$scope.pwdQst[2]&&$scope.pwdQst[0].a&&$scope.pwdQst[1].a&&$scope.pwdQst[2].a?void self.updateOne({"accountInfo.pwdQuestions":$scope.pwdQst}).then(function(data){$scope.error.pwdQstError="",$scope.pwdQstModal.remove().then(function(){$scope.pwdQstModal=null,$scope.pwdQst=[]})},function(err){$scope.error.pwdQstError=err.data}):void($scope.error.pwdQstError="输入不能为空!")}},self.takePicsModal=function($scope,images){$ionicModal.fromTemplateUrl("partials/modal/takePics.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.takePicsModal=modal,$scope.takePicsModal.show()}),$scope.actions=$scope.actions||{},$scope.error=$scope.error||{},$scope.pageHandler=$scope.pageHandler||{progress:0};for(var i=0;i<images.length;i++)for(var j=0;j<$scope.config.images.length;j++)$scope.config.images[j].title===images[i].title&&($scope.config.images[j].Url=images[i].Url,$scope.config.images[j]._id=images[i]._id);var cameraOptions=angular.copy(CONFIG.cameraOptions),uploadOptions=angular.copy(CONFIG.uploadOptions);$scope.currentIndex=0,$timeout(function(){$scope.slidesCount=$ionicSlideBoxDelegate.$getByHandle("takePics").slidesCount(),$ionicSlideBoxDelegate.$getByHandle("takePics").enableSlide(!1),$ionicSlideBoxDelegate.$getByHandle("takePics").update()},500),$scope.actions.closeTakePics=function(){$scope.takePicsModal.hide()},$scope.actions.rmTakePics=function(){$scope.takePicsModal.remove().then(function(){$scope.takePicsModal=null})},$scope.actions.previous=function(){$ionicSlideBoxDelegate.$getByHandle("takePics").previous()},$scope.actions.next=function(){$ionicSlideBoxDelegate.$getByHandle("takePics").next()},$scope.actions.getIndex=function(){$scope.slidesCount=$ionicSlideBoxDelegate.$getByHandle("takePics").slidesCount(),$scope.currentIndex=$ionicSlideBoxDelegate.$getByHandle("takePics").currentIndex(),$scope.error.takePicsError=""},$scope.actions.takePics=function(imgTitle,_id){$cordovaCamera.getPicture(cameraOptions).then(function(imageURI){$timeout(function(){var serverUrl=encodeURI(CONFIG.baseUrl+CONFIG.userResUploadPath);uploadOptions.headers={Authorization:"Bearer "+Storage.get("token")},uploadOptions.fileName="imgTitle"+CONFIG.uploadOptions.fileExt,uploadOptions.params={method:"$set",dest:"personalInfo.idImg",queryTitle:imgTitle,_id:_id,replace:!0,inArray:!0},PageFunc.confirm("是否上传?","上传"+imgTitle).then(function(res){if(res)return $cordovaFileTransfer.upload(serverUrl,imageURI,uploadOptions,!0).then(function(result){$scope.pageHandler.progress=0,$scope.error.takePicsError="";for(var resImg=JSON.parse(result.response).results,i=0;i<resImg.length;i++)for(var j=0;j<$scope.config.images.length;j++)$scope.config.images[j].title===resImg[i].title&&($scope.config.images[j].Url=resImg[i].Url,$scope.config.images[j]._id=resImg[i]._id);try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(err){$scope.error.takePicsError=err,$scope.pageHandler.progress=0;try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}},function(progress){$scope.pageHandler.progress=progress.loaded/progress.total*100});$scope.pageHandler.progress=0,$scope.error.takePicsError="取消上传!";try{$cordovaCamera.cleanup().then(function(){console.log("Camera cleanup success.")},function(err){console.log(err)})}catch(e){console.log(e)}})},0)},function(err){$scope.error.takePicsError=err,console.log(err)})}},self.initAccInfo=function($scope){$scope.error={};var deferred=$q.defer();if(Storage.get("AccInfo")){$scope.accountInfo=JSON.parse(Storage.get("AccInfo"));try{$scope.accountInfo.user.personalInfo.birthdate&&($scope.accountInfo.user.personalInfo.birthdate=new Date($scope.accountInfo.user.personalInfo.birthdate))}catch(e){}}return self.getAccInfo().then(function(data){$scope.accountInfo=data.results;try{$scope.accountInfo.user.personalInfo.birthdate&&($scope.accountInfo.user.personalInfo.birthdate=new Date($scope.accountInfo.user.personalInfo.birthdate))}catch(e){}Storage.set("AccInfo",JSON.stringify(data.results)),deferred.resolve(data.results)},function(err){deferred.reject(err)}),deferred.promise},self.initInfo=function($scope){$scope.error={};var deferred=$q.defer();return Storage.get("info")&&($scope.info=JSON.parse(Storage.get("info")),$scope.info.personalInfo.birthdate&&($scope.info.personalInfo.birthdate=new Date($scope.info.personalInfo.birthdate))),self.getInfo().then(function(data){$scope.info=data.results;try{$scope.info.personalInfo.birthdate&&($scope.info.personalInfo.birthdate=new Date($scope.info.personalInfo.birthdate))}catch(e){}finally{}Storage.set("info",JSON.stringify(data.results)),deferred.resolve(data.results)},function(err){deferred.reject(err)}),deferred.promise},self}]).factory("Insurance",["Storage","Data","Token","$state","$q","jwtHelper",function(Storage,Data,Token,$state,$q,jwtHelper){return{getInfo:function(query,options,fields){var deferred=$q.defer();return Data.Insurance.getInfo({query:query,options:options,fields:fields},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},getList:function(query,options,fields){var deferred=$q.defer();return Data.Insurance.getList(query,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},modify:function(ince,options){var deferred=$q.defer();return Data.Insurance.modify(ince,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},remove:function(ince){var deferred=$q.defer();return Data.Insurance.remove(ince,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},removeOne:function(ince,options){var deferred=$q.defer();return Data.Insurance.removeOne(ince,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise}}}]).factory("Consumption",["Storage","Data","Token","$state","$q","jwtHelper",function(Storage,Data,Token,$state,$q,jwtHelper){return{insertOne:function(cons,options){var deferred=$q.defer();return Data.Consumption.insertOne(cons,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},getOne:function(query,options,fields){var deferred=$q.defer();return Data.Consumption.getOne({query:query,options:options,fields:fields},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},getList:function(query,options,fields){var deferred=$q.defer();return Data.Consumption.getList({query:query,options:options,fields:fields},function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise},updateOne:function(cons,options){var deferred=$q.defer();return Data.Consumption.updateOne(cons,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise}}}]).factory("Post",["Storage","Data","Token","$state","$q","jwtHelper",function(Storage,Data,Token,$state,$q,jwtHelper){return{post:function(post,options){var deferred=$q.defer();return Data.Post.post(post,function(data,headers){deferred.resolve(data)},function(err){deferred.reject(err)}),deferred.promise}}}]).factory("PageFunc",["$ionicPopup","$timeout",function($ionicPopup,$timeout){return{message:function(_msg,_time,_title){var messagePopup=$ionicPopup.alert({title:_title||"消息",template:_msg,okText:"确认",okType:"button-energized"});return _time&&$timeout(function(){messagePopup.close("Timeout!")},_time),messagePopup},confirm:function(_msg,_title){var confirmPopup=$ionicPopup.confirm({title:_title,template:_msg,cancelText:"取消",cancelType:"button-default",okText:"确定",okType:"button-energized"});return confirmPopup},prompt:function(_msg,_title){var promptPopup=$ionicPopup.prompt({title:_title,template:_msg,inputType:"password",inputPlaceholder:_msg,cancelText:"取消",cancelType:"button-default",okText:"确定",okType:"button-energized"});return promptPopup}}}]).factory("Auth",["Storage","Data","$q","ACL","Token",function(Storage,Data,$q,ACL,Token){return{authorize:function(accessLevel,role){return void 0===role&&(role=ACL.userRoles[Token.curUserRole()]),accessLevel.bitMask&role.bitMask},isLoggedIn:function(){return!Token.isExpired()}}}]);